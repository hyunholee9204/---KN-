<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>대출 관리</title>
    <link rel="stylesheet" href="/css/l/Loans.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<!-- 상단 바 -->
<div class="header">
    <div class="header-left" onclick="goToMain()">KN금융</div>
    <div class="nav-wrapper">
        <div class="nav-menu">
            <a href="/asset">자산 관리</a>
            <a href="/loans">대출 관리</a>
            <a href="/target">목표 달성 트래킹</a>
            <a href="/education/guide">교육 및 정보</a>
            <a href="/notice">공지사항</a>
            <a href="/inquiry">고객센터</a>
        </div>
    </div>
</div>

<!-- 메인 컨테이너 -->
<div class="container">
    <!-- 사이드바 -->
    <div class="sidebar">
        <button onclick="location.href='/loans/register'">대출 등록</button>
        <button onclick="location.href='/loans/schedule'">대출 상환 일정</button>
        <button onclick="location.href='/loans/calculate'">이자율 계산</button>
    </div>

    <!-- 콘텐츠 -->
    <div class="content">
        <!-- 안내 박스 -->
        <div class="info-box">
            <h3>📢 대출 전 꼭 확인하세요!</h3>
            <ul>
                <li>대출은 상환 능력을 고려하여 신중하게 결정해야 합니다.</li>
                <li>이자율과 상환 기간에 따라 총 상환 금액이 크게 달라질 수 있습니다.</li>
                <li>불필요한 대출은 신용 점수에 영향을 줄 수 있습니다.</li>
                <li>항상 <strong>상환 계획</strong>을 먼저 수립하고 대출을 진행하세요.</li>
            </ul>
        </div>

        <!-- 대출 요약 카드 -->
        <h2>대출 현황</h2>
        <div class="loan-summary">
            <div class="card">
                <h4>총 대출 금액</h4>
                <p th:text="${totalLoanAmount}">₩0</p>
            </div>
            <div class="card">
                <h4>대출 개수</h4>
                <p th:text="${#lists.size(loans)}">0</p>
            </div>
            <div class="card">
                <h4>평균 이자율</h4>
                <p th:text="${#numbers.formatDecimal(avgInterestRate, 1, 2)} + '%'">0%</p>
            </div>
        </div>

        <!-- 대출 내역 테이블 -->
        <table class="loan-list">
            <thead>
            <tr>
                <th>대출 기관</th>
                <th>종류</th>
                <th>대출 금액</th>
                <th>이자율</th>
                <th>시작일</th>
                <th>종료일</th>
                <th>상환 횟수</th>
                <th>관리</th> <!-- ✅ 추가 -->
            </tr>
            </thead>
            <tbody>
            <tr th:each="loan : ${loans}">
                <td th:text="${loan.lender}"></td>
                <td th:text="${loan.loanType}"></td>
                <td th:text="${loan.formattedAmount}"></td>
                <td th:text="${loan.interestRate} + '%'"></td>
                <td th:text="${loan.startDate}"></td>
                <td th:text="${loan.endDate}"></td>
                <td th:text="${loan.totalInstallments}"></td>

                <!-- ✅ 수정 / 삭제 버튼 -->
                <td class="loan-actions">
                    <a th:href="@{'/loans/edit/' + ${loan.id}}" class="edit-btn">수정</a>
                    <a th:href="@{'/loans/delete/' + ${loan.id}}"
                       onclick="return confirm('정말 삭제하시겠습니까?')"
                       class="delete-btn">삭제</a>
                </td>
            </tr>
            </tbody>
        </table>

        <!-- 그래프 -->
        <div class="charts">
            <canvas id="loanChart"></canvas>
            <canvas id="loanPieChart"></canvas>
        </div>
    </div>
</div>
<script th:inline="javascript">
    /*<![CDATA[*/
    const loans = /*[[${loans}]]*/ [];

    // ✅ 같은 loanType끼리 합산
    const grouped = {};
    loans.forEach(l => {
      const type = l.loanType;
      const amount = l.principal;
      grouped[type] = (grouped[type] || 0) + amount;
    });

    // ✅ Chart.js에 들어갈 데이터
    const loanTypes = Object.keys(grouped);
    const loanAmounts = Object.values(grouped);

    // ✅ 색상 배열 자동 생성 (종류 수에 맞게)
    const colors = [
      'rgba(255, 99, 132, 0.6)',
      'rgba(54, 162, 235, 0.6)',
      'rgba(255, 206, 86, 0.6)',
      'rgba(75, 192, 192, 0.6)',
      'rgba(153, 102, 255, 0.6)',
      'rgba(255, 159, 64, 0.6)',
      'rgba(201, 203, 207, 0.6)'
    ];
    const bgColors = loanTypes.map((_, i) => colors[i % colors.length]);

    // ✅ 막대 그래프
    const ctx = document.getElementById('loanChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: loanTypes,
        datasets: [{
          label: '대출 금액 (₩)',
          data: loanAmounts,
          backgroundColor: bgColors,
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: v => v.toLocaleString() + '₩'
            }
          }
        }
      }
    });

    // ✅ 파이 그래프
    const ctx2 = document.getElementById('loanPieChart').getContext('2d');
    new Chart(ctx2, {
      type: 'pie',
      data: {
        labels: loanTypes,
        datasets: [{
          label: '대출 금액 비율',
          data: loanAmounts,
          backgroundColor: bgColors
        }]
      },
      options: { responsive: true }
    });
    /*]]>*/
</script>

<script>
    function goToMain() {
        window.location.href = "/main";
    }
</script>
</body>
</html>

