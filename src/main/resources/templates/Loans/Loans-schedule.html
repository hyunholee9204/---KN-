<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>대출 상환 일정 | KN금융</title>
    <link rel="stylesheet" href="/css/l/l-schedule.css">
</head>
<body>

<!-- 상단 바 -->
<div class="header">
    <div class="header-left" onclick="goToMain()">KN금융</div>
    <div class="nav-wrapper">
        <div class="nav-menu">
            <a href="/asset">자산 관리</a>
            <a href="/loans">대출 관리</a>
            <a href="/target">목표 달성 트래킹</a>
            <a href="/education/guide">교육 및 정보</a>
            <a href="/notice">공지사항</a>
            <a href="/inquiry">고객센터</a>
        </div>
    </div>
</div>

<!-- 메인 컨테이너 -->
<div class="container">
    <!-- 사이드바 -->
    <div class="sidebar">
        <button onclick="location.href='/loans'">대출 현황</button>
        <button class="active">대출 상환 일정</button>
        <button onclick="location.href='/loans/calculate'">이자율 계산</button>
    </div>

    <!-- 콘텐츠 -->
    <div class="content">
        <h2>📅 대출 상환 일정</h2>

        <!-- 🔹 대출 선택 드롭다운 -->
        <div class="loan-select">
            <label for="loanSelect"><strong>대출 선택:</strong></label>
            <select id="loanSelect" onchange="changeLoan()">
                <option value=""
                        th:selected="${selectedLoan == null}">
                    대출을 선택하세요
                </option>
                <option th:each="loan : ${loans}"
                        th:value="${loan.id}"
                        th:selected="${selectedLoan != null and selectedLoan.id == loan.id}"
                        th:text="${loan.lender + ' - ' + loan.loanType.description + ' ('
                + #numbers.formatInteger(loan.principal, 3, 'COMMA') + '원, '
                + loan.startDate + ')'}">
                </option>
            </select>
        </div>

        <!-- ✅ 상환 일정 없을 때 -->
        <div th:if="${#lists.isEmpty(schedule)}" class="empty-box">
            <p>📭 대출을 선택하면 상환 일정이 표시됩니다.</p>
        </div>

        <!-- ✅ 상환 일정 있을 때 -->
        <div th:unless="${#lists.isEmpty(schedule)}">

            <!-- 요약 카드 -->
            <div class="loan-summary">
                    <div class="card">
                        <h4>다음 상환일</h4>
                        <p th:text="${nextDateText}">2025-12-25</p>
                    </div>
                    <div class="card">
                        <h4>남은 횟수</h4>
                        <p th:text="${remainingText}">5회</p>
                    </div>
                    <div class="card">
                        <h4>대출 금액</h4>
                        <p th:text="${#numbers.formatInteger(selectedLoan.principal, 3, 'COMMA')} + '원'">
                            1,000,000원
                        </p>
                    </div>
            </div>

            <!-- 상환 테이블 -->
            <table class="loan-schedule-table">
                <thead>
                <tr>
                    <th>회차</th>
                    <th>상환일</th>
                    <th>원금</th>
                    <th>이자</th>
                    <th>총 상환액</th>
                    <th>상태</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="repayment : ${schedule}">
                    <td th:text="${repayment != null ? repayment.installmentNo : ''}"></td>
                    <td th:text="${repayment != null ? repayment.dueDate : ''}"></td>
                    <td th:text="${repayment != null ? #numbers.formatInteger(repayment.principal, 3, 'COMMA') + '원' : ''}"></td>
                    <td th:text="${repayment != null ? #numbers.formatInteger(repayment.interest, 3, 'COMMA') + '원' : ''}"></td>
                    <td th:text="${repayment != null ? #numbers.formatInteger(repayment.totalAmount, 3, 'COMMA') + '원' : ''}"></td>
                    <td th:text="${repayment != null && repayment.status != null ? repayment.status : '예정'}"></td>
                </tr>
                </tbody>
            </table>

            <!-- 총합 박스 -->
            <div class="total-box">
                <p>
                    💰 총 상환 금액:
                    <strong th:text="${#numbers.formatInteger(totalRepay, 3, 'COMMA')} + '원'">7,000,000원</strong>
                    &nbsp;|&nbsp;
                    총 이자:
                    <strong th:text="${#numbers.formatInteger(totalInterest, 3, 'COMMA')} + '원'">350,000원</strong>
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    function goToMain() {
        window.location.href = "/main";
    }

    function changeLoan() {
        const select = document.getElementById("loanSelect");
        const loanId = select.value?.trim();

        if (loanId && loanId !== "") {
            window.location.href = "/loans/schedule/" + loanId;
        } else {
            console.warn("⚠️ 선택된 대출 ID가 없습니다.");
        }
    }
</script>

</body>
</html>
