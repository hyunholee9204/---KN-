<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê¸ˆìœµ ì •ë³´ ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="/css/e/finance.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
        }
        .up { color: red; }
        .down { color: blue; }
        .neutral { color: gray; }

        .finance-section { margin-top: 25px; }

        ul.quick-links li {
            list-style: none;
            margin: 8px 0;
        }
        ul.quick-links li a {
            text-decoration: none;
            color: #0056b3;
            font-weight: 500;
        }
        ul.quick-links li a:hover {
            text-decoration: underline;
        }
        #news-list li {
            margin-bottom: 5px;
        }
        #news-list a {
            text-decoration: none;
            color: #333;
        }
        #news-list a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
<div class="header">
    <div class="header-left" onclick="location.href='/main'">KNê¸ˆìœµ</div>
    <div class="nav-wrapper">
        <div class="nav-menu">
            <a href="/asset">ìì‚° ê´€ë¦¬</a>
            <a href="/loans">ëŒ€ì¶œ ê´€ë¦¬</a>
            <a href="/target">ëª©í‘œ ë‹¬ì„± íŠ¸ë˜í‚¹</a>
            <a href="/education/guide">êµìœ¡ ë° ì •ë³´</a>
            <a href="/notice">ê³µì§€ì‚¬í•­</a>
            <a href="/inquiry">ê³ ê°ì„¼í„°</a>
        </div>
    </div>
</div>

<div class="container">
    <div class="sidebar">
        <button onclick="location.href='/education/guide'">êµìœ¡</button>
        <button onclick="location.href='/finance/info'">ê¸ˆìœµ ì •ë³´</button>
    </div>

    <div class="content">
        <h2>ì‹¤ì‹œê°„ í™˜ìœ¨ ì •ë³´ (1ë‹¨ìœ„ ê¸°ì¤€)</h2>

        <div class="finance-section">
            <p>ë¯¸êµ­ ë‹¬ëŸ¬ (USD â†’ KRW, 1ë‹¬ëŸ¬ë‹¹ ì›í™”):
                <span id="usd-rate">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
            </p>
            <p>ìœ ë¡œ (EUR â†’ KRW, 1ìœ ë¡œë‹¹ ì›í™”):
                <span id="eur-rate">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
            </p>
        </div>

        <h3>ìµœê·¼ 7ì¼ í™˜ìœ¨ ì¶”ì´</h3>
        <canvas id="exchangeChart" width="500" height="280"></canvas>

        <div class="finance-section">
            <h3>ë‹¤ë¥¸ ê¸ˆìœµ ì§€í‘œ ë°”ë¡œê°€ê¸°</h3>
            <ul class="quick-links">
                <li><a href="https://finance.naver.com/sise/" target="_blank">ğŸ“ˆ ì£¼ì‹ ì§€ìˆ˜ (KOSPI / KOSDAQ)</a></li>
                <li><a href="https://www.bok.or.kr/portal/main/main.do" target="_blank">ğŸ’° í•œêµ­ì€í–‰ ê¸°ì¤€ê¸ˆë¦¬ ë³´ê¸°</a></li>
                <li><a href="https://www.koreagoldx.co.kr" target="_blank">ğŸ… ê¸ˆ ì‹œì„¸ í™•ì¸í•˜ê¸°</a></li>
            </ul>
        </div>

        <div class="finance-section">
            <h3>ìµœê·¼ ê¸ˆìœµ ë‰´ìŠ¤</h3>
            <ul id="news-list"><li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li></ul>
        </div>
    </div>
</div>

<script>
    const chartData = {};

    // âœ… í™˜ìœ¨ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadExchangeRates() {
        const currencies = ["USD", "EUR"];
        const today = new Date().toISOString().split("T")[0];
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 7);
        const sevenDaysAgo = startDate.toISOString().split("T")[0];

        for (let cur of currencies) {
            const res = await fetch(`https://api.frankfurter.app/${sevenDaysAgo}..${today}?from=${cur}&to=KRW`);
            const data = await res.json();
            const dates = Object.keys(data.rates);
            const values = dates.map(d => data.rates[d]["KRW"]);

            const latest = values[values.length - 1];
            const weekAgo = values[0];
            const diff = latest - weekAgo;
            const diffRate = (diff / weekAgo) * 100;

            const el = document.getElementById(`${cur.toLowerCase()}-rate`);
            let cls = "neutral", arrow = "";
            if (diff > 0) { cls = "up"; arrow = "â–²"; }
            else if (diff < 0) { cls = "down"; arrow = "â–¼"; }

            el.innerHTML = `
                <strong>${latest.toLocaleString(undefined, {maximumFractionDigits: 2})}</strong> ì›
                <span class="${cls}" style="margin-left:8px;">
                    ${arrow} ${Math.abs(diff).toFixed(2)} (${diffRate.toFixed(2)}%)
                </span>
            `;

            chartData[cur] = { dates, values };
        }
    }

    // âœ… ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
    async function drawChart() {
        const ctx = document.getElementById("exchangeChart").getContext("2d");
        new Chart(ctx, {
            type: "line",
            data: {
                labels: chartData["USD"].dates,
                datasets: [
                    {
                        label: "USD â†’ KRW",
                        data: chartData["USD"].values,
                        borderColor: "red",
                        tension: 0.3,
                        fill: false
                    },
                    {
                        label: "EUR â†’ KRW",
                        data: chartData["EUR"].values,
                        borderColor: "blue",
                        tension: 0.3,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: "bottom" }
                },
                scales: {
                    y: {
                        ticks: { stepSize: 250 },
                        title: { display: true, text: "â‚© (KRW)" }
                    }
                }
            }
        });
    }

    // âœ… ë‰´ìŠ¤ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadNews() {
        const newsList = document.getElementById("news-list");
        newsList.innerHTML = "<li>ë‰´ìŠ¤ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>";

        try {
            const res = await fetch("/finance/news");
            const data = await res.json();

            if (!data.articles) {
                newsList.innerHTML = "<li>ë‰´ìŠ¤ ë°ì´í„° ì—†ìŒ</li>";
                return;
            }

            newsList.innerHTML = "";
            data.articles.slice(0, 5).forEach(article => {
                const li = document.createElement("li");
                li.innerHTML = `
                    <a href="${article.url}" target="_blank">
                        ğŸ— ${article.title}
                        <small style="color:gray;"> (${article.source.name || "ì¶œì²˜ ë¯¸ìƒ"})</small>
                    </a>`;
                newsList.appendChild(li);
            });
        } catch (err) {
            console.error("ë‰´ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
            newsList.innerHTML = "<li>ë‰´ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</li>";
        }
    }

    // âœ… ì‹¤í–‰ ìˆœì„œ
    document.addEventListener("DOMContentLoaded", async () => {
        await loadExchangeRates();
        await drawChart();
        await loadNews();
    });
</script>
</body>
</html>

